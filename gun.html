<!DOCTYPE html>
<html>
<head>
    <title>Tic Tac Toe - Host</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 5px; margin: 20px auto; }
        .cell { width: 100px; height: 100px; font-size: 2rem; display: flex; justify-content: center; align-items: center; border: 1px solid #333; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Host: Tic Tac Toe</h1>
    <p>Game ID: <span id="gameId"></span></p>
    <p>Status: <span id="status">Waiting for Player 2...</span></p>
    <div id="board" class="board" style="display:none;"></div>

    <script>
        const gun = Gun();

        const gameId = Math.random().toString(36).substring(2, 8); // Generate unique game ID
        const game = gun.get(gameId);
        document.getElementById("gameId").innerText = gameId;

        const boardDiv = document.getElementById("board");
        const statusText = document.getElementById("status");

        // Initialize game state
        game.put({
            players: 1,
            board: JSON.stringify(["", "", "", "", "", "", "", "", ""]),
            currentPlayer: "X",
            status: "Waiting for Player 2..."
        });

        // Listen for game updates
        game.on((data) => {
            if (!data) return;

            // Ensure default values
            const board = JSON.parse(data.board || '["", "", "", "", "", "", "", "", ""]');
            const players = data.players || 0;
            const status = data.status || "Waiting for updates...";

            // Update status and render the board
            if (players === 2) {
                statusText.innerText = status;
                boardDiv.style.display = "grid";
                renderBoard(board);
            } else {
                statusText.innerText = "Waiting for Player 2...";
            }

            if (data.winner) {
                alert(`Player ${data.winner} wins!`);
                boardDiv.style.display = "none";
            }
        });

        function renderBoard(board) {
            boardDiv.innerHTML = "";
            board.forEach((cell, index) => {
                const cellDiv = document.createElement("div");
                cellDiv.className = "cell";
                cellDiv.innerText = cell;
                cellDiv.onclick = () => makeMove(index, board);
                boardDiv.appendChild(cellDiv);
            });
        }

        function makeMove(index, board) {
            game.once((data) => {
                if (board[index] || data.currentPlayer !== "X" || data.status !== "Player 1's Turn") return;
                const newBoard = [...board];
                newBoard[index] = "X";
                const winner = checkWinner(newBoard);
                game.put({
                    board: JSON.stringify(newBoard),
                    currentPlayer: "O",
                    status: winner ? "Player X Wins!" : "Player 2's Turn",
                    winner: winner || null
                });
            });
        }

        function checkWinner(board) {
            const winningCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (const [a, b, c] of winningCombinations) {
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
            }
            return null;
        }
    </script>
</body>
</html>